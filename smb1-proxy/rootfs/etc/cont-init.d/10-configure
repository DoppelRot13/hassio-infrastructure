#!/usr/bin/with-contenv bashio
set -euo pipefail

TC_HOST="$(bashio::config 'tc_host')"
TC_SHARE="$(bashio::config 'tc_share')"
TC_USER="$(bashio::config 'tc_username')"
TC_PASS="$(bashio::config 'tc_password')"
TC_DOMAIN="$(bashio::config 'tc_domain')"
MOUNT_POINT="$(bashio::config 'mount_point')"
REXPORT_NAME="$(bashio::config 'reexport_share_name')"
ALLOW_NTLMV1="$(bashio::config 'allow_ntlmv1')"
ALLOW_SMB1="$(bashio::config 'allow_smb1')"
HOSTS_ALLOW_JSON="$(bashio::config 'hosts_allow')"
INTERFACES_JSON="$(bashio::config 'interfaces')"

HOSTS_ALLOW="$(echo "${HOSTS_ALLOW_JSON}" | jq -r '.[]' | xargs || true)"
INTERFACES="$(echo "${INTERFACES_JSON}" | jq -r '.[]' | xargs || true)"

mkdir -p "${MOUNT_POINT}" /data /etc/samba /root/.smb /run/samba /share

cat > /etc/samba/smb.conf <<CONF
[global]
   client min protocol = $( [ "${ALLOW_SMB1}" = "true" ] && echo NT1 || echo SMB2 )
   client max protocol = SMB3
   $( [ "${ALLOW_NTLMV1}" = "true" ] && echo "client ntlmv2 auth = no" || echo "client ntlmv2 auth = yes" )
   $( [ "${ALLOW_NTLMV1}" = "true" ] && echo "ntlm auth = yes" || echo "ntlm auth = no" )
CONF

AUTH_FILE="/root/.smb/smbnetfs.auth"
cat > "${AUTH_FILE}" <<EOF
auth "${TC_HOST}" "${TC_SHARE}" "${TC_USER}" "${TC_PASS}" "${TC_DOMAIN}"
EOF
chmod 600 "${AUTH_FILE}"

cat > /root/.smb/smbnetfs.conf <<'EOF'
# smbnetfs minimal config; client protocol forced by /etc/samba/smb.conf
EOF

cat > /etc/samba/smb-server.conf <<CONF
[global]
   server role = standalone server
   server string = SMB1 TimeCapsule Gateway
   workgroup = WORKGROUP
   log file = /dev/stdout
   max log size = 0
   map to guest = Bad User
   passdb backend = tdbsam
   server min protocol = SMB2
   server max protocol = SMB3
   $( [ "${ALLOW_NTLMV1}" = "true" ] && echo "ntlm auth = yes" || echo "ntlm auth = no" )
   $( [ -n "${INTERFACES}" ] && echo "interfaces = ${INTERFACES}" )
   $( [ -n "${INTERFACES}" ] && echo "bind interfaces only = yes" )

[${REXPORT_NAME}]
   path = ${MOUNT_POINT}
   browseable = yes
   writeable = yes
   read only = no
   guest ok = no
   force user = root
   create mask = 0644
   directory mask = 0755
CONF

if [ -n "${HOSTS_ALLOW}" ]; then
  echo "   hosts allow = ${HOSTS_ALLOW}" >> /etc/samba/smb-server.conf
fi

if pdbedit -L | grep -q "^${TC_USER}:"; then
  (echo "${TC_PASS}"; echo "${TC_PASS}") | smbpasswd -s "${TC_USER}" || true
else
  adduser -D -H -s /sbin/nologin "${TC_USER}" 2>/dev/null || adduser --disabled-password --gecos "" "${TC_USER}" || true
  (echo "${TC_PASS}"; echo "${TC_PASS}") | smbpasswd -a -s "${TC_USER}"
fi

bashio::log.info "Config ready. Will mount //${TC_HOST}/${TC_SHARE} -> ${MOUNT_POINT}."
