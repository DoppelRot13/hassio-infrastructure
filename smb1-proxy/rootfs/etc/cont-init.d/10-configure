#!/usr/bin/with-contenv bashio
# Configure Samba at container init using Home Assistant bashio
set -euo pipefail

# Read options
WORKGROUP="$(bashio::config 'workgroup')"
SHARE_NAME="$(bashio::config 'share_name')"
EXPORT_PATH="$(bashio::config 'export_path')"
USERNAME="$(bashio::config 'username')"
PASSWORD="$(bashio::config 'password')"
READ_ONLY="$(bashio::config 'read_only')"
ALLOW_SMB1="$(bashio::config 'allow_smb1')"
ALLOW_NTLMV1="$(bashio::config 'allow_ntlmv1')"
GUEST_OK="$(bashio::config 'guest_ok')"

# Arrays (JSON) to space-separated lists
HOSTS_ALLOW_JSON="$(bashio::config 'hosts_allow')"
INTERFACES_JSON="$(bashio::config 'interfaces')"

HOSTS_ALLOW="$(echo "${HOSTS_ALLOW_JSON}" | jq -r '.[]' | xargs || true)"
INTERFACES="$(echo "${INTERFACES_JSON}" | jq -r '.[]' | xargs || true)"

mkdir -p "${EXPORT_PATH}" /etc/samba

# Build smb.conf
{
  echo "[global]"
  echo "   server role = standalone server"
  echo "   server string = SMB1 Proxy"
  echo "   workgroup = ${WORKGROUP}"
  echo "   log file = /dev/stdout"
  echo "   max log size = 0"
  echo "   load printers = no"
  echo "   disable spoolss = yes"
  echo "   dns proxy = no"

  # Protocol min/max
  if [ "${ALLOW_SMB1}" = "true" ]; then
    echo "   server min protocol = NT1"
    echo "   server max protocol = SMB3"
  else
    echo "   server min protocol = SMB2"
    echo "   server max protocol = SMB3"
  fi

  # Auth
  if [ "${ALLOW_NTLMV1}" = "true" ]; then
    echo "   ntlm auth = yes"
  else
    echo "   ntlm auth = no"
  fi

  echo "   map to guest = Bad User"
  echo "   passdb backend = tdbsam"

  # Networking
  if [ -n "${INTERFACES}" ]; then
    echo "   interfaces = ${INTERFACES}"
    echo "   bind interfaces only = yes"
  fi
  if [ -n "${HOSTS_ALLOW}" ]; then
    echo "   hosts allow = ${HOSTS_ALLOW}"
  fi

  echo ""
  echo "[${SHARE_NAME}]"
  echo "   path = ${EXPORT_PATH}"
  echo "   browseable = yes"
  if [ "${READ_ONLY}" = "true" ]; then
    echo "   read only = yes"
    echo "   writeable = no"
  else
    echo "   read only = no"
    echo "   writeable = yes"
  fi
  if [ "${GUEST_OK}" = "true" ]; then
    echo "   guest ok = yes"
  else
    echo "   guest ok = no"
  fi
  echo "   force user = root"
  echo "   create mask = 0644"
  echo "   directory mask = 0755"
} > /etc/samba/smb.conf

bashio::log.info "Generated /etc/samba/smb.conf:"
cat /etc/samba/smb.conf

# Create/Update SMB user if not guest
if [ "${GUEST_OK}" != "true" ]; then
  if pdbedit -L | grep -q "^${USERNAME}:"; then
    bashio::log.info "Updating SMB password for user ${USERNAME}"
    (echo "${PASSWORD}"; echo "${PASSWORD}") | smbpasswd -s "${USERNAME}" || true
  else
    bashio::log.info "Creating SMB user ${USERNAME}"
    adduser -D -H -s /sbin/nologin "${USERNAME}" 2>/dev/null || adduser --disabled-password --gecos "" "${USERNAME}" || true
    (echo "${PASSWORD}"; echo "${PASSWORD}") | smbpasswd -a -s "${USERNAME}"
  fi
fi

bashio::log.info "smb1-proxy configuration complete."
